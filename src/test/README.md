# 稅務計算器測試文檔

## 測試概述

本專案為台灣綜合所得稅計算器的稅務計算邏輯提供了全面的單元測試，確保計算結果的準確性和可靠性。

## 測試結構

### 1. 核心邏輯測試 (`taxRules.test.ts`)

測試 `src/data/taxRules.ts` 中的所有稅務計算函數：

#### `calculateDeductions` - 扣除額計算測試
- ✅ 單身標準扣除額計算
- ✅ 已婚標準扣除額計算
- ✅ 70歲以上長輩免稅額計算
- ✅ 幼兒學前特別扣除額（第1名150,000元，第2名起225,000元）
- ✅ 教育學費特別扣除額（每人25,000元）
- ✅ 身心障礙特別扣除額（每人218,000元）
- ✅ 長期照顧特別扣除額（每人120,000元）
- ✅ 儲蓄投資特別扣除額（上限270,000元）
- ✅ 房屋租金特別扣除額（上限180,000元）
- ✅ 列舉扣除額 vs 標準扣除額選擇邏輯
- ✅ 基本生活費差額計算

#### `calculateTax` - 稅額計算測試
- ✅ 5%稅率級距（0-59萬）
- ✅ 12%稅率級距（59-133萬）
- ✅ 20%稅率級距（133-266萬）
- ✅ 30%稅率級距（266-498萬）
- ✅ 40%稅率級距（498萬以上）
- ✅ 零收入和負收入處理
- ✅ 有效稅率計算

#### `calculateNetIncome` - 所得淨額計算測試
- ✅ 正常所得淨額計算
- ✅ 扣除額大於總收入的邊界情況

#### `calculateFullTaxInfo` - 完整稅務資訊測試
- ✅ 一般家庭完整計算流程
- ✅ 複雜家庭情況（多種扣除額組合）

#### 邊界條件測試
- ✅ 稅率級距邊界值測試
- ✅ 極大收入值處理
- ✅ 最小扣除額情況

#### 稅務常數驗證
- ✅ 2025年稅率級距設定
- ✅ 免稅額金額驗證
- ✅ 標準扣除額金額驗證

### 2. 實際情境測試 (`taxScenarios.test.ts`)

模擬真實納稅人情況的綜合測試：

#### 典型家庭情境
- ✅ **單身上班族**（年收入50萬）
  - 綜合所得淨額：262,000元
  - 應納稅額：13,100元
  - 有效稅率：5%

- ✅ **雙薪夫妻**（年收入100萬）
  - 綜合所得淨額：494,000元
  - 應納稅額：24,700元
  - 有效稅率：5%

- ✅ **四口之家**（2個6歲以下子女，年收入150萬）
  - 綜合所得淨額：445,000元
  - 應納稅額：22,250元
  - 有效稅率：5%

- ✅ **三代同堂家庭**（扶養2位70歲以上長輩）
  - 綜合所得淨額：906,000元
  - 應納稅額：67,420元
  - 有效稅率：7.44%

#### 特殊扣除額情境
- ✅ **租屋族**（房租18萬）
- ✅ **大專學生家庭**（2個學生）
- ✅ **身心障礙家庭**
- ✅ **長期照顧家庭**

#### 列舉扣除額情境
- ✅ **高額醫療費用家庭**
- ✅ **購屋族**（房貸利息30萬）
- ✅ **高收入慈善家**（大額捐贈）

#### 高稅率級距情境
- ✅ **高收入單身**（適用30%稅率）
  - 綜合所得淨額：3,002,000元
  - 應納稅額：486,900元
  - 有效稅率：16.22%

- ✅ **超高收入家庭**（適用40%稅率）
  - 綜合所得淨額：6,705,000元
  - 應納稅額：1,770,300元
  - 有效稅率：26.40%

#### 免稅門檻測試
- ✅ 單身上班族免稅門檻驗證
- ✅ 雙薪夫妻免稅門檻驗證

### 3. 工具與 Hook 測試 (`utilsFunctions.test.ts`, `useLocalStorage.test.tsx`, `useTaxCalculation.test.tsx`)

- ✅ **公用格式化函式**：`formatNumber`, `formatCurrency`（lib 與 utils 版本輸出一致）
- ✅ **CSS class 合併**：`cn` 函式處理 falsy 值
- ✅ **useLocalStorage Hook**：
  - 初始值讀取
  - `setValue` 同步更新 `localStorage`
- ✅ **useTaxCalculation Hook**：
  - 單身情境（5%級距、有效稅率 <= 5%）
  - 已婚 *auto* 情境（自動選擇最省稅方案、`allMethods` & `savingsComparedToCombined` 驗證）

## 測試覆蓋率

- **稅務計算邏輯**：100% 覆蓋率
- **函數覆蓋率**：100%
- **分支覆蓋率**：100%
- **行覆蓋率**：100%

## 運行測試

```bash
# 運行所有測試
npm test

# 運行測試並生成覆蓋率報告
npm run test:coverage

# 運行特定測試檔案
npm run test:run src/test/taxRules.test.ts
npm run test:run src/test/taxScenarios.test.ts
```

## 測試策略

### 1. 單元測試
- 測試每個計算函數的獨立功能
- 驗證邊界條件和異常情況
- 確保數學計算的準確性

### 2. 整合測試
- 測試完整的稅務計算流程
- 驗證不同扣除額之間的交互作用
- 確保複雜情況下的計算正確性

### 3. 情境測試
- 模擬真實納稅人的各種情況
- 驗證常見稅務情境的計算結果
- 確保實用性和準確性

### 4. 回歸測試
- 防止代碼變更影響現有功能
- 確保稅務規則更新時的向後兼容性
- 維護計算結果的一致性

## 測試數據來源

所有測試數據基於：
- 財政部2025年綜合所得稅相關法規
- 官方稅率級距表
- 各項扣除額標準金額
- 實際稅務計算案例

## 維護指南

### 新增測試
1. 在相應的測試檔案中新增測試案例
2. 確保測試覆蓋新功能的所有分支
3. 提供清晰的測試描述和期望結果

### 更新測試
1. 稅務規則變更時，更新相關測試案例
2. 修正期望值以反映新的計算結果
3. 確保所有測試通過後再提交變更

### 測試最佳實踐
1. 使用描述性的測試名稱
2. 提供詳細的計算過程註釋
3. 測試邊界條件和異常情況
4. 保持測試的獨立性和可重複性

## 最新測試覆蓋率（`npm run test:coverage`）

| 指標 | 覆蓋率 |
|------|--------|
| 行 (Lines) | **96%** |
| 陳述式 (Statements) | **96%** |
| 函式 (Functions) | **81%** |
| 分支 (Branches) | **72%** |

> UI 元件 (`*.tsx`) 及靜態文案/i18n 已排除覆蓋率計算。